# GitLab CI/CD 설정
# Oracle Cloud 인스턴스에 GitLab을 설치한 경우 사용

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Backend: Spring Boot 빌드
build-springboot:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker info
  script:
    - |
      if [ -d "backend/springboot" ]; then
        cd backend/springboot
        docker build -f Dockerfile -t $CI_REGISTRY_IMAGE/springboot:$CI_COMMIT_SHA .
        docker push $CI_REGISTRY_IMAGE/springboot:$CI_COMMIT_SHA
      else
        echo "backend/springboot 디렉토리가 없습니다. 빌드를 건너뜁니다."
      fi
  only:
    - main
    - develop
  when: on_success

# Backend: Kotlin 빌드
build-kotlin:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker info
  script:
    - |
      if [ -d "backend/kotlin" ]; then
        cd backend/kotlin
        docker build -f Dockerfile -t $CI_REGISTRY_IMAGE/kotlin:$CI_COMMIT_SHA .
        docker push $CI_REGISTRY_IMAGE/kotlin:$CI_COMMIT_SHA
      else
        echo "backend/kotlin 디렉토리가 없습니다. 빌드를 건너뜁니다."
      fi
  only:
    - main
    - develop
  when: on_success

# Frontend: Vue.js 빌드
build-vue:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker info
  script:
    - |
      if [ -d "frontend/vue" ]; then
        cd frontend/vue
        docker build -f Dockerfile -t $CI_REGISTRY_IMAGE/vue:$CI_COMMIT_SHA .
        docker push $CI_REGISTRY_IMAGE/vue:$CI_COMMIT_SHA
      else
        echo "frontend/vue 디렉토리가 없습니다. 빌드를 건너뜁니다."
      fi
  only:
    - main
    - develop
  when: on_success

# Backend 테스트
test-backend:
  stage: test
  image: gradle:7.6-jdk17
  script:
    - |
      if [ -d "backend/springboot" ]; then
        cd backend/springboot
        ./gradlew test || true
      fi
      if [ -d "backend/kotlin" ]; then
        cd backend/kotlin
        ./gradlew test || true
      fi
  only:
    - main
    - develop
  when: on_success

# 통합 테스트
test-integration:
  stage: test
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - docker info
    - apk add --no-cache curl
  script:
    - |
      # .env 파일 생성
      cp env.example .env || true
      echo "MYSQL_ROOT_PASSWORD=test_password" >> .env
      echo "MYSQL_DATABASE=test_db" >> .env
      echo "MYSQL_USER=test_user" >> .env
      echo "MYSQL_PASSWORD=test_password" >> .env
      
      # Docker Compose 서비스 시작
      docker-compose up -d
      sleep 30
      
      # Health check
      curl -f http://localhost:3000/api/springboot/health || echo "Spring Boot API 헬스 체크 실패"
      curl -f http://localhost:3000/api/kotlin/health || echo "Kotlin API 헬스 체크 실패"
      
      # 서비스 중지
      docker-compose down
  only:
    - main
    - develop
  when: on_success

# 배포 (프로덕션) - 태그 기반 배포
# 사용법: git tag -a v1.0.0 -m "Release v1.0.0" && git push origin v1.0.0
deploy-production:
  stage: deploy
  image: docker:latest
  # docker:dind 제거 - 호스트 Docker 소켓 직접 사용
  before_script:
    - apk add --no-cache docker-compose curl
    - docker info
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - |
      echo "=========================================="
      echo "배포 시작: $(date)"
      echo "=========================================="
      
      # 환경 변수 파일 확인
      if [ ! -f .env ]; then
        echo "경고: .env 파일이 없습니다."
        if [ -f env.example ]; then
          cp env.example .env
          echo "env.example을 .env로 복사했습니다. 수정이 필요합니다."
        else
          echo "오류: env.example 파일도 없습니다."
          exit 1
        fi
      fi
      
      # 롤링 배포를 위한 스케일링 설정
      echo "롤링 배포 시작..."
      
      # 프로덕션 이미지 빌드
      echo "Docker 이미지 빌드 중..."
      docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache backend-springboot backend-kotlin
      
      # Spring Boot 롤링 배포
      echo "Spring Boot 롤링 배포 중..."
      # 1. 새 인스턴스 1개 추가 (총 2개)
      docker-compose -f docker-compose.yml -f docker-compose.scale.yml up -d --scale backend-springboot=2 --no-deps backend-springboot
      
      # 2. 헬스 체크 대기
      echo "새 Spring Boot 인스턴스 헬스 체크 대기 중..."
      sleep 15
      MAX_RETRIES=10
      RETRY_COUNT=0
      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
          echo "Spring Boot 새 인스턴스 정상 작동 확인"
          break
        fi
        RETRY_COUNT=$((RETRY_COUNT + 1))
        echo "재시도 중... ($RETRY_COUNT/$MAX_RETRIES)"
        sleep 5
      done
      
      # 3. 기존 인스턴스 중지 (자동으로 1개만 남음)
      echo "기존 Spring Boot 인스턴스 교체 중..."
      docker-compose -f docker-compose.yml -f docker-compose.scale.yml up -d --scale backend-springboot=2 backend-springboot
      sleep 10
      
      # Kotlin 롤링 배포
      echo "Kotlin 롤링 배포 중..."
      # 1. 새 인스턴스 1개 추가 (총 2개)
      docker-compose -f docker-compose.yml -f docker-compose.scale.yml up -d --scale backend-kotlin=2 --no-deps backend-kotlin
      
      # 2. 헬스 체크 대기
      echo "새 Kotlin 인스턴스 헬스 체크 대기 중..."
      sleep 15
      RETRY_COUNT=0
      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        if curl -f http://localhost:3000/api/kotlin/health > /dev/null 2>&1; then
          echo "Kotlin 새 인스턴스 정상 작동 확인"
          break
        fi
        RETRY_COUNT=$((RETRY_COUNT + 1))
        echo "재시도 중... ($RETRY_COUNT/$MAX_RETRIES)"
        sleep 5
      done
      
      # 3. 기존 인스턴스 중지 (자동으로 1개만 남음)
      echo "기존 Kotlin 인스턴스 교체 중..."
      docker-compose -f docker-compose.yml -f docker-compose.scale.yml up -d --scale backend-kotlin=2 backend-kotlin
      sleep 10
      
      # 다른 서비스 시작 (MySQL, Frontend 등)
      echo "다른 서비스 시작 중..."
      docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d mysql frontend-vue
      
      # 최종 헬스 체크
      echo "최종 헬스 체크 중..."
      sleep 10
      
      MAX_RETRIES=10
      RETRY_COUNT=0
      
      while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
        if curl -f http://localhost:3000/api/health > /dev/null 2>&1 && \
           curl -f http://localhost:3000/api/kotlin/health > /dev/null 2>&1; then
          echo "=========================================="
          echo "롤링 배포 완료: $(date)"
          echo "모든 서비스가 정상적으로 시작되었습니다!"
          echo "=========================================="
          echo "실행 중인 컨테이너:"
          docker-compose -f docker-compose.yml -f docker-compose.scale.yml ps
          echo "=========================================="
          echo "Backend 인스턴스 수:"
          docker-compose -f docker-compose.yml -f docker-compose.scale.yml ps | grep -E 'backend-springboot|backend-kotlin' | wc -l
          exit 0
        fi
        
        RETRY_COUNT=$((RETRY_COUNT + 1))
        echo "재시도 중... ($RETRY_COUNT/$MAX_RETRIES)"
        sleep 5
      done
      
      echo "경고: 일부 서비스가 시작되지 않았습니다."
      docker-compose ps
      docker-compose logs --tail=50
      exit 1
  only:
    - tags  # 태그가 생성될 때만 실행
  when: manual  # 수동 실행 (자동 실행 원하면 'on_success'로 변경)
  environment:
    name: production
    url: http://localhost:3000

