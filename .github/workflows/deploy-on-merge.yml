name: Deploy on Merge

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /path/to/nas
            git pull origin main
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build
            
            # 헬스 체크
            sleep 20
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3000/api/springboot/health && \
                 curl -f http://localhost:3000/api/kotlin/health; then
                echo "배포 완료: 모든 서비스가 정상적으로 시작되었습니다!"
                exit 0
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "재시도 중... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            done
            
            echo "경고: 일부 서비스가 시작되지 않았습니다."
            docker-compose ps
            docker-compose logs --tail=50
            exit 1
