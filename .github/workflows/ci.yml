name: CI Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**', 'release/**', 'hotfix/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Backend: Spring Boot 빌드 및 테스트
  backend-springboot:
    name: Spring Boot Backend
    runs-on: ubuntu-latest
    if: ${{ hashFiles('backend/springboot/**') != '' || github.event_name == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check if backend exists
        id: check_backend
        run: |
          if [ -d "backend/springboot" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up JDK 17
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        if: steps.check_backend.outputs.exists == 'true'
        run: chmod +x backend/springboot/gradlew
        working-directory: backend/springboot
      
      - name: Build with Gradle
        if: steps.check_backend.outputs.exists == 'true'
        run: ./gradlew build
        working-directory: backend/springboot
      
      - name: Run tests
        if: steps.check_backend.outputs.exists == 'true'
        run: ./gradlew test
        working-directory: backend/springboot
      
      - name: Build Docker image
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          docker build -f backend/springboot/Dockerfile -t nas-backend-springboot:${{ github.sha }} ./backend/springboot
      
      - name: Upload build artifacts
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: springboot-jar
          path: backend/springboot/build/libs/*.jar

  # Backend: Kotlin (Ktor) 빌드 및 테스트
  backend-kotlin:
    name: Kotlin Backend
    runs-on: ubuntu-latest
    if: ${{ hashFiles('backend/kotlin/**') != '' || github.event_name == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check if backend exists
        id: check_backend
        run: |
          if [ -d "backend/kotlin" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up JDK 17
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Grant execute permission for gradlew
        if: steps.check_backend.outputs.exists == 'true'
        run: chmod +x backend/kotlin/gradlew
        working-directory: backend/kotlin
      
      - name: Build with Gradle
        if: steps.check_backend.outputs.exists == 'true'
        run: ./gradlew build
        working-directory: backend/kotlin
      
      - name: Run tests
        if: steps.check_backend.outputs.exists == 'true'
        run: ./gradlew test
        working-directory: backend/kotlin
      
      - name: Build Docker image
        if: steps.check_backend.outputs.exists == 'true'
        run: |
          docker build -f backend/kotlin/Dockerfile -t nas-backend-kotlin:${{ github.sha }} ./backend/kotlin
      
      - name: Upload build artifacts
        if: steps.check_backend.outputs.exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: kotlin-jar
          path: backend/kotlin/build/libs/*.jar

  # Frontend: Vue.js 빌드 및 테스트
  frontend-vue:
    name: Vue.js Frontend
    runs-on: ubuntu-latest
    if: ${{ hashFiles('frontend/vue/**') != '' || github.event_name == 'pull_request' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check if frontend exists
        id: check_frontend
        run: |
          if [ -d "frontend/vue" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Node.js
        if: steps.check_frontend.outputs.exists == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/vue/package-lock.json
      
      - name: Install dependencies
        if: steps.check_frontend.outputs.exists == 'true'
        run: npm ci
        working-directory: frontend/vue
        continue-on-error: true
      
      - name: Lint code
        if: steps.check_frontend.outputs.exists == 'true'
        run: npm run lint
        working-directory: frontend/vue
        continue-on-error: true
      
      - name: Build application
        if: steps.check_frontend.outputs.exists == 'true'
        run: npm run build
        working-directory: frontend/vue
        env:
          NODE_ENV: production
        continue-on-error: true
      
      - name: Build Docker image
        if: steps.check_frontend.outputs.exists == 'true'
        run: |
          docker build -f frontend/vue/Dockerfile -t nas-frontend-vue:${{ github.sha }} ./frontend/vue
        continue-on-error: true
      
      - name: Upload build artifacts
        if: steps.check_frontend.outputs.exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: vue-dist
          path: frontend/vue/dist
        continue-on-error: true

  # Docker Compose 통합 테스트
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [backend-springboot, backend-kotlin, frontend-vue]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Compose
        run: |
          docker-compose --version
      
      - name: Create .env file
        run: |
          cp env.example .env
          echo "MYSQL_ROOT_PASSWORD=test_password" >> .env
          echo "MYSQL_DATABASE=test_db" >> .env
          echo "MYSQL_USER=test_user" >> .env
          echo "MYSQL_PASSWORD=test_password" >> .env
      
      - name: Start services
        run: |
          docker-compose up -d
          sleep 30  # 서비스 시작 대기
      
      - name: Check service health
        run: |
          curl -f http://localhost:3000/api/springboot/health || exit 1
          curl -f http://localhost:3000/api/kotlin/health || exit 1
      
      - name: Stop services
        run: docker-compose down
        if: always()

