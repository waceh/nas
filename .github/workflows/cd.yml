name: CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # 수동 실행 가능

jobs:
  # Docker 이미지 빌드 및 푸시 (선택사항)
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        if: ${{ secrets.DOCKER_USERNAME != '' }}
      
      - name: Build and push Spring Boot image
        uses: docker/build-push-action@v4
        with:
          context: ./backend/springboot
          file: ./backend/springboot/Dockerfile
          push: ${{ secrets.DOCKER_USERNAME != '' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/nas-backend-springboot:latest
            ${{ secrets.DOCKER_USERNAME }}/nas-backend-springboot:${{ github.sha }}
        if: ${{ secrets.DOCKER_USERNAME != '' }}
      
      - name: Build and push Kotlin image
        uses: docker/build-push-action@v4
        with:
          context: ./backend/kotlin
          file: ./backend/kotlin/Dockerfile
          push: ${{ secrets.DOCKER_USERNAME != '' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/nas-backend-kotlin:latest
            ${{ secrets.DOCKER_USERNAME }}/nas-backend-kotlin:${{ github.sha }}
        if: ${{ secrets.DOCKER_USERNAME != '' }}
      
      - name: Build and push Vue.js image
        uses: docker/build-push-action@v4
        with:
          context: ./frontend/vue
          file: ./frontend/vue/Dockerfile
          push: ${{ secrets.DOCKER_USERNAME != '' }}
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/nas-frontend-vue:latest
            ${{ secrets.DOCKER_USERNAME }}/nas-frontend-vue:${{ github.sha }}
        if: ${{ secrets.DOCKER_USERNAME != '' }}

  # Oracle Cloud 인스턴스에 배포
  deploy:
    name: Deploy to Oracle Cloud
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.ref == 'refs/heads/main' && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Oracle Cloud
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
            set -e
            cd ${{ secrets.SERVER_DEPLOY_PATH }}
            
            echo "=========================================="
            echo "배포 시작: $(date)"
            echo "=========================================="
            
            # Git pull
            echo "Git 저장소 업데이트 중..."
            git fetch origin
            git reset --hard origin/main
            
            # 환경 변수 파일 확인
            if [ ! -f .env ]; then
              echo "경고: .env 파일이 없습니다. env.example을 복사하여 생성하세요."
              if [ -f env.example ]; then
                cp env.example .env
                echo "env.example을 .env로 복사했습니다. .env 파일을 수정하세요."
              fi
            fi
            
            # 배포 스크립트 실행
            if [ -f ci-cd/deploy.sh ]; then
              chmod +x ci-cd/deploy.sh
              ./ci-cd/deploy.sh production
            else
              echo "오류: ci-cd/deploy.sh 파일을 찾을 수 없습니다."
              exit 1
            fi
          DEPLOY_SCRIPT
      
      - name: Health Check
        run: |
          echo "헬스 체크 대기 중..."
          sleep 15
          
          echo "Spring Boot API 헬스 체크..."
          curl -f http://${{ secrets.SERVER_HOST }}:3000/api/springboot/health || echo "경고: Spring Boot API 헬스 체크 실패"
          
          echo "Kotlin API 헬스 체크..."
          curl -f http://${{ secrets.SERVER_HOST }}:3000/api/kotlin/health || echo "경고: Kotlin API 헬스 체크 실패"
          
          echo "프론트엔드 접속 확인..."
          curl -f http://${{ secrets.SERVER_HOST }}:3000 || echo "경고: 프론트엔드 접속 실패"

