name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'  # v로 시작하는 태그
  pull_request:
    branches:
      - main
      - develop

env:
  DOCKER_BUILDKIT: 1

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Spring Boot Backend
        if: contains(github.event.head_commit.message, 'backend') || contains(github.event.head_commit.message, 'springboot') || github.event_name == 'push'
        run: |
          if [ -d "backend/springboot" ]; then
            cd backend/springboot
            docker build -f Dockerfile.dev -t nas-backend-springboot:latest .
            docker tag nas-backend-springboot:latest nas-backend-springboot:${{ github.sha }}
          fi

      - name: Build Kotlin Backend
        if: contains(github.event.head_commit.message, 'backend') || contains(github.event.head_commit.message, 'kotlin') || github.event_name == 'push'
        run: |
          if [ -d "backend/kotlin" ]; then
            cd backend/kotlin
            docker build -f Dockerfile.dev -t nas-backend-kotlin:latest .
            docker tag nas-backend-kotlin:latest nas-backend-kotlin:${{ github.sha }}
          fi

      - name: Build Vue Frontend
        if: contains(github.event.head_commit.message, 'frontend') || contains(github.event.head_commit.message, 'vue') || github.event_name == 'push'
        run: |
          if [ -d "frontend/vue" ]; then
            cd frontend/vue
            docker build -f Dockerfile.dev -t nas-frontend-vue:latest .
            docker tag nas-frontend-vue:latest nas-frontend-vue:${{ github.sha }}
          fi

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Test Spring Boot Backend
        if: contains(github.event.head_commit.message, 'backend') || contains(github.event.head_commit.message, 'springboot') || github.event_name == 'push'
        run: |
          if [ -d "backend/springboot" ]; then
            cd backend/springboot
            ./gradlew test || true
          fi

      - name: Test Kotlin Backend
        if: contains(github.event.head_commit.message, 'backend') || contains(github.event.head_commit.message, 'kotlin') || github.event_name == 'push'
        run: |
          if [ -d "backend/kotlin" ]; then
            cd backend/kotlin
            ./gradlew test || true
          fi

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test]
    if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /path/to/nas
            git pull origin main
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            
            # 헬스 체크
            sleep 20
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3000/api/springboot/health && \
                 curl -f http://localhost:3000/api/kotlin/health; then
                echo "배포 완료: 모든 서비스가 정상적으로 시작되었습니다!"
                exit 0
              fi
              
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "재시도 중... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            done
            
            echo "경고: 일부 서비스가 시작되지 않았습니다."
            docker-compose ps
            docker-compose logs --tail=50
            exit 1
